name: Auto-Release Helper

on:
  push:
    branches:
      - main
    paths:
      - 'VERSION'
      - 'CHANGELOG.md'

permissions:
  contents: read

jobs:
  check-version:
    runs-on: ubuntu-latest
    name: Validate Version & Changelog
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | grep -E "^v?[0-9]+\.[0-9]+\.[0-9]+" | head -1)
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version: $VERSION"
      
      - name: Check CHANGELOG has version entry
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if ! grep -q "## \[v$VERSION\]" CHANGELOG.md; then
            echo "‚ö†Ô∏è  Version v$VERSION not found in CHANGELOG.md"
            echo "Please add release notes before tagging."
            exit 1
          fi
          echo "‚úÖ CHANGELOG.md has entry for v$VERSION"
      
      - name: Check version consistency
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Check setup.py
          if grep -q "version=\"$VERSION\"" setup.py; then
            echo "‚úÖ setup.py has correct version"
          else
            echo "‚ùå setup.py version mismatch"
            exit 1
          fi
          
          # Check pyproject.toml
          if grep -q "version = \"$VERSION\"" pyproject.toml; then
            echo "‚úÖ pyproject.toml has correct version"
          else
            echo "‚ùå pyproject.toml version mismatch"
            exit 1
          fi
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Audit dependencies for vulnerabilities
        run: |
          echo "üîç Running dependency audit..."
          pip install pip-audit
          pip-audit --desc || true
          echo "‚úÖ Dependency audit complete"
